<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso Funcional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #3B82F6; }
        body { font-family: 'Segoe UI', sans-serif; background: #F8FAFC; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* Roles */
        .teacher-only, .student-only { display: none !important; }
        body.role-teacher .teacher-only { display: block !important; }
        body.role-student .student-only { display: block !important; }

        header { background: white; padding: 15px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .layout { display: grid; grid-template-columns: 250px 1fr; flex: 1; overflow: hidden; }
        .sidebar { background: white; border-right: 1px solid #ddd; padding: 20px; }
        .content { padding: 40px; overflow-y: auto; }
        
        .tab-btn { display: block; width: 100%; padding: 12px; border: none; background: none; text-align: left; font-size: 1rem; color: #64748B; cursor: pointer; border-radius: 8px; margin-bottom: 5px; }
        .tab-btn.active { background: var(--blue); color: white; font-weight: bold; }
        .section { display: none; }
        .section.active { display: block; }
        
        .card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; position: relative; }
        .btn { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; color: white; margin-right: 5px; font-size: 0.9rem;}
        .btn-blue { background: var(--blue); } .btn-red { background: #EF4444; } .btn-green { background: #10B981; } .btn-yellow { background: #F59E0B; } .btn-dark { background: #1E293B; }
        .edit-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit;}

        .grading-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .grading-table th { background: #F1F5F9; text-align: left; padding: 8px; }
        .grading-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .input-grade { width: 50px; text-align: center; }
        .delete-absolute { position: absolute; top: 15px; right: 15px; background: transparent; color: #EF4444; font-size: 1.2rem; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <header>
        <a href="cursos.html" style="text-decoration:none; color:#333; font-weight:bold;"><i class="fas fa-arrow-left"></i> Volver a Cursos</a>
        <span id="role-badge" style="color:var(--blue); font-weight:bold;">Cargando...</span>
    </header>

    <div class="layout">
        <div class="sidebar">
            <h3 style="color:#1E293B; margin-bottom:20px;">Ética y Deontología</h3>
            <button class="tab-btn active" onclick="showTab('temas', this)">Temas</button>
            <button class="tab-btn" onclick="showTab('tareas', this)">Tareas</button>
            <button class="tab-btn" onclick="showTab('notas', this)">Calificaciones</button>
        </div>

        <div class="content">
            <div id="temas" class="section active">
                <h2 style="border-bottom:2px solid #ddd; padding-bottom:10px;">Contenido del Curso</h2>
                <div class="teacher-only" style="background:#FFFBEB; border:2px dashed #F59E0B; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:#D97706;">+ Agregar Nuevo Tema</h4>
                    <input type="text" id="newTopicTitle" placeholder="Título (Ej: Historia)" class="edit-input">
                    <textarea id="newTopicDesc" placeholder="Descripción..." class="edit-input" rows="2"></textarea>
                    <button class="btn btn-blue" onclick="addTopic()">Publicar Tema</button>
                </div>
                <div id="topic-list"></div>
            </div>

            <div id="tareas" class="section">
                <h2 style="border-bottom:2px solid #ddd; padding-bottom:10px;">Actividades</h2>
                <div class="teacher-only" style="background:#F0F9FF; border:2px dashed var(--blue); padding:15px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:var(--blue);">+ Crear Nueva Tarea</h4>
                    <input type="text" id="newTaskTitle" placeholder="Título (Ej: Examen)" class="edit-input">
                    <textarea id="newTaskDesc" placeholder="Instrucciones..." class="edit-input" rows="2"></textarea>
                    <button class="btn btn-dark" onclick="addTask()">Asignar Tarea</button>
                </div>
                <div id="task-list"></div>
            </div>

            <div id="notas" class="section">
                <h2>Boleta de Notas</h2>
                <div class="student-only">
                    <p>Tus calificaciones:</p>
                    <table class="grading-table" id="student-report-card">
                        <thead><tr><th>Actividad</th><th>Nota</th><th>Estado</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="teacher-only"><p>Ve a "Tareas" para calificar.</p></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. BASE DE DATOS DE ESTUDIANTES ---
        const studentsDB = [
            { id: 1, name: "Chavez Ayala, Kaysin" }, { id: 2, name: "Alvarez, Maria" },
            { id: 3, name: "Benitez, Jorge" }, { id: 4, name: "Castillo, Pedro" },
            { id: 5, name: "Diaz, Ana" }, { id: 6, name: "Espinoza, Luis" },
            { id: 7, name: "Fernandez, Sofia" }, { id: 8, name: "Garcia, Miguel" },
            { id: 9, name: "Hernandez, Jose" }, { id: 10, name: "Iglesias, Carmen" },
            { id: 11, name: "Jimenez, Raul" }, { id: 12, name: "Lopez, Elena" },
            { id: 13, name: "Martinez, Carlos" }, { id: 14, name: "Nuñez, Patricia" },
            { id: 15, name: "Ortega, David" }, { id: 16, name: "Perez, Juan" },
            { id: 17, name: "Quispe, Rosa" }, { id: 18, name: "Ramirez, Fernando" },
            { id: 19, name: "Sanchez, Lucía" }, { id: 20, name: "Torres, Manuel" }
        ];

        // --- 2. GESTIÓN DE DATOS (NUEVA CLAVE v3 PARA REINICIAR) ---
        const STORAGE_KEY = 'course_data_v3_fixed'; 

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : { topics: [], tasks: [] };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // Variable global
        let currentData = loadData();

        // --- 3. INICIALIZACIÓN ---
        document.addEventListener("DOMContentLoaded", function() {
            const role = localStorage.getItem('userRole') || 'student';
            const name = localStorage.getItem('userName');
            const userId = localStorage.getItem('userId');

            document.body.classList.add('role-' + role);
            document.getElementById('role-badge').innerHTML = `${name}`;

            renderAll(role, userId);
        });

        function showTab(id, btn) {
            document.querySelectorAll('.section, .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        // --- 4. RENDERIZADO ---
        function renderAll(role, userId) {
            // A) TEMAS
            const topicList = document.getElementById('topic-list');
            topicList.innerHTML = '';
            
            if(currentData.topics.length === 0) topicList.innerHTML = '<p style="color:#999; text-align:center;">No hay temas publicados.</p>';

            currentData.topics.forEach((t, i) => {
                topicList.innerHTML += `
                    <div class="card" id="topic-${t.id}">
                        <div class="view-mode">
                            <h3>Tema ${i+1}: ${t.title}</h3>
                            <p style="color:#666;">${t.desc}</p>
                            <div class="teacher-only teacher-actions" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; text-align:right;">
                                <button class="btn btn-yellow" onclick="toggleEdit('topic', ${t.id})"><i class="fas fa-edit"></i> Editar</button>
                                <button class="btn btn-red" onclick="deleteItem('topic', ${t.id})"><i class="fas fa-trash"></i> Eliminar</button>
                            </div>
                        </div>
                        <div class="edit-mode" style="display:none;">
                            <input type="text" id="edit-topic-title-${t.id}" class="edit-input" value="${t.title}">
                            <textarea id="edit-topic-desc-${t.id}" class="edit-input" rows="2">${t.desc}</textarea>
                            <div style="text-align:right; margin-top:10px;">
                                <button class="btn btn-green" onclick="saveEdit('topic', ${t.id})">Guardar</button>
                                <button class="btn" style="background:#ccc; color:#333;" onclick="toggleEdit('topic', ${t.id})">Cancelar</button>
                            </div>
                        </div>
                    </div>`;
            });

            // B) TAREAS
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            
            if(currentData.tasks.length === 0) taskList.innerHTML = '<p style="color:#999; text-align:center;">No hay tareas asignadas.</p>';

            currentData.tasks.forEach((t, i) => {
                const myGrade = userId ? localStorage.getItem(`grade_${t.id}_${userId}`) : null;
                const gradeDisplay = myGrade ? `Nota: ${myGrade}` : "Sin nota";
                const gradeStyle = myGrade ? "background:#DCFCE7; color:#166534;" : "background:#eee;";

                taskList.innerHTML += `
                    <div class="card" id="task-${t.id}" style="border-left: 4px solid var(--blue);">
                        <div class="view-mode">
                            <div style="display:flex; justify-content:space-between;">
                                <h3>Actividad ${i+1}: ${t.title}</h3>
                                <span class="student-only" style="padding:5px 10px; border-radius:5px; font-weight:bold; ${gradeStyle}">${gradeDisplay}</span>
                            </div>
                            <p>${t.desc}</p>
                            
                            <div class="student-only">
                                <input type="file" style="margin-top:10px;">
                                <button class="btn btn-blue" style="margin-top:10px;" onclick="alert('Enviado')">Entregar</button>
                            </div>

                            <div class="teacher-only teacher-actions" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; text-align:right;">
                                <div style="float:left;">
                                    <details>
                                        <summary style="cursor:pointer; color:var(--blue); font-weight:bold;">Calificar (20)</summary>
                                        <div style="max-height:300px; overflow-y:auto; margin-top:10px; text-align:left;">
                                            <table class="grading-table">
                                                <thead><tr><th>Alumno</th><th>Nota</th><th>Ok</th></tr></thead>
                                                <tbody>${generateStudentRows(t.id)}</tbody>
                                            </table>
                                        </div>
                                    </details>
                                </div>
                                <button class="btn btn-yellow" onclick="toggleEdit('task', ${t.id})"><i class="fas fa-edit"></i> Editar</button>
                                <button class="btn btn-red" onclick="deleteItem('task', ${t.id})"><i class="fas fa-trash"></i> Eliminar</button>
                                <div style="clear:both;"></div>
                            </div>
                        </div>
                        <div class="edit-mode" style="display:none;">
                            <input type="text" id="edit-task-title-${t.id}" class="edit-input" value="${t.title}">
                            <textarea id="edit-task-desc-${t.id}" class="edit-input" rows="2">${t.desc}</textarea>
                            <div style="text-align:right; margin-top:10px;">
                                <button class="btn btn-green" onclick="saveEdit('task', ${t.id})">Guardar</button>
                                <button class="btn" style="background:#ccc; color:#333;" onclick="toggleEdit('task', ${t.id})">Cancelar</button>
                            </div>
                        </div>
                    </div>`;
            });

            // C) BOLETA (Solo Alumno)
            if(role === 'student') {
                const tbody = document.querySelector('#student-report-card tbody');
                tbody.innerHTML = '';
                currentData.tasks.forEach((t, i) => {
                    const g = localStorage.getItem(`grade_${t.id}_${userId}`);
                    tbody.innerHTML += `<tr><td>Actividad ${i+1}: ${t.title}</td><td>${g || '-'}</td><td>${g ? 'Calificado' : 'Pendiente'}</td></tr>`;
                });
            }
        }

        function generateStudentRows(taskId) {
            return studentsDB.map(s => {
                const grade = localStorage.getItem(`grade_${taskId}_${s.id}`) || "";
                return `<tr>
                        <td>${s.name}</td>
                        <td><input type="number" id="in-${taskId}-${s.id}" value="${grade}" class="input-grade"></td>
                        <td><button class="btn btn-green" onclick="saveGrade(${taskId}, ${s.id})">✔</button></td>
                    </tr>`;
            }).join('');
        }

        // --- 5. FUNCIONES CRUD (TOTALMENTE GLOBALES) ---
        
        function addTopic() {
            const title = document.getElementById('newTopicTitle').value;
            const desc = document.getElementById('newTopicDesc').value;
            
            if (title.trim() === "") {
                alert("Por favor escribe un título para el tema.");
                return;
            }

            // Agregamos al array
            currentData.topics.push({ id: Date.now(), title: title, desc: desc });
            saveData(currentData);
            
            // Recargamos la vista
            renderAll('teacher', null);
            
            // Limpiamos los campos
            document.getElementById('newTopicTitle').value = "";
            document.getElementById('newTopicDesc').value = "";
        }

        function addTask() {
            const title = document.getElementById('newTaskTitle').value;
            const desc = document.getElementById('newTaskDesc').value;
            
            if (title.trim() === "") {
                alert("Por favor escribe un título para la tarea.");
                return;
            }

            currentData.tasks.push({ id: Date.now(), title: title, desc: desc });
            saveData(currentData);
            
            renderAll('teacher', null);
            
            document.getElementById('newTaskTitle').value = "";
            document.getElementById('newTaskDesc').value = "";
        }

        function deleteItem(type, id) {
            if(confirm("¿Estás seguro de eliminar este elemento?")) {
                if(type === 'topic') {
                    currentData.topics = currentData.topics.filter(x => x.id !== id);
                } else {
                    currentData.tasks = currentData.tasks.filter(x => x.id !== id);
                }
                saveData(currentData);
                renderAll('teacher', null);
            }
        }

        function toggleEdit(type, id) {
            const card = document.getElementById(`${type}-${id}`);
            const v = card.querySelector('.view-mode'); 
            const e = card.querySelector('.edit-mode');
            
            if (v.style.display === 'none') {
                v.style.display = 'block'; 
                e.style.display = 'none'; 
            } else { 
                v.style.display = 'none'; 
                e.style.display = 'block'; 
            }
        }

        function saveEdit(type, id) {
            const nt = document.getElementById(`edit-${type}-title-${id}`).value;
            const nd = document.getElementById(`edit-${type}-desc-${id}`).value;
            
            const arr = type === 'topic' ? currentData.topics : currentData.tasks;
            const item = arr.find(x => x.id === id);
            
            item.title = nt; 
            item.desc = nd;
            
            saveData(currentData); 
            renderAll('teacher', null);
        }

        function saveGrade(taskId, sId) {
            const val = document.getElementById(`in-${taskId}-${sId}`).value;
            if (val === "" || (val >= 0 && val <= 20)) {
                localStorage.setItem(`grade_${taskId}_${sId}`, val);
                alert("Nota guardada correctamente.");
            } else {
                alert("La nota debe ser entre 0 y 20.");
            }
        }
    </script>
</body>
</html>
